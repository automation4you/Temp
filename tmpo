# Login to Azure
Connect-AzAccount

# Import the CSV file
$csvFilePath = "C:\path\to\vm_tags.csv"
$vmTags = Import-Csv -Path $csvFilePath

# Validate CSV structure
if (-not ($vmTags -and $vmTags[0].PSObject.Properties.Name -contains "Computer Name" -and
         $vmTags[0].PSObject.Properties.Name -contains "Subscription" -and 
         $vmTags[0].PSObject.Properties.Name -contains "Backup Tag Name" -and 
         $vmTags[0].PSObject.Properties.Name -contains "Backup Tag Value")) {
    Write-Error "CSV file is missing required columns. Check: Computer Name, Subscription, Backup Tag Name, Backup Tag Value."
    return
}

# Initialize success/failure tracking
$successList = @()
$failureList = @()

# Loop through CSV entries
foreach ($entry in $vmTags) {
    $vmName = $entry.'Computer Name'.Trim()
    $subscriptionId = $entry.Subscription.Trim()
    $category = $entry.'Backup Tag Name'.Trim()
    $value = $entry.'Backup Tag Value'.Trim()

    try {
        # Try setting the Azure context (fails if subscription is invalid)
        Set-AzContext -SubscriptionId $subscriptionId -ErrorAction Stop | Out-Null
    } catch {
        Write-Warning "Subscription '$subscriptionId' does not exist or you don't have access. Skipping VM '$vmName'."
        $failureList += "$vmName (Invalid Subscription: $subscriptionId)"
        continue  # Skip to the next VM
    }

    try {
        # Get the VM in the specified subscription
        $vm = Get-AzVM -Name $vmName -ErrorAction SilentlyContinue

        if ($null -eq $vm) {
            Write-Warning "VM '$vmName' not found in subscription '$subscriptionId'. Skipping."
            $failureList += $vmName
            continue
        }

        # Ensure tags exist
        if ($null -eq $vm.Tags) { $vm.Tags = @{} }

        # Check if the tag is already set correctly
        if ($vm.Tags[$category] -eq $value) {
            Write-Host "Tag '$category' already set to '$value' for VM '$vmName'. Skipping update." -ForegroundColor Cyan
            $successList += $vmName
            continue
        }

        # Update the tag
        $tag = @{ $category = $value }
        Update-AzTag -ResourceId $vm.Id -Tag $tag -Operation Merge -WhatIf
        Write-Host "Added/Updated tag '$category=$value' for VM '$vmName'." -ForegroundColor Green
        $successList += $vmName
    } catch {
        Write-Error "Failed to update tags for VM '$vmName' in subscription '$subscriptionId': $($_.Exception.Message)"
        $failureList += $vmName
    }
}

# Summary Report
Write-Host "`nSummary:" -ForegroundColor Cyan
Write-Host "Successfully updated VMs:" -ForegroundColor Green
$successList | ForEach-Object { Write-Host $_ }

Write-Host "Failed to update VMs:" -ForegroundColor Red
$failureList | ForEach-Object { Write-Warning $_ }
