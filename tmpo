# Login to Azure
Connect-AzAccount

# Import the CSV file that contains VM names, subscription, tag category, and tag value
$csvFilePath = "C:\path\to\vm_tags.csv"
$vmTags = Import-Csv -Path $csvFilePath

# Validate CSV file structure
if (-not ($vmTags -and $vmTags[0].PSObject.Properties.Name -contains "Computer Name" -and
         $vmTags[0].PSObject.Properties.Name -contains "Subscription" -and 
         $vmTags[0].PSObject.Properties.Name -contains "Backup Tag Name" -and 
         $vmTags[0].PSObject.Properties.Name -contains "Backup Tag Value")) {
    Write-Error "CSV file is missing required columns: Computer Name, Subscription, Backup Tag Name, or Backup Tag Value."
    return
}

# Initialize success and failure tracking
$successList = @()
$failureList = @()

# Loop through each entry in the CSV file
foreach ($entry in $vmTags) {
    $vmName = $entry.'Computer Name'.Trim()        # Assuming column name is "Computer Name"
    $subscriptionId = $entry.Subscription.Trim()   # Subscription ID for the VM
    $category = $entry.'Backup Tag Name'.Trim()    # Tag Category (Key)
    $value = $entry.'Backup Tag Value'.Trim()      # Tag Value

    Write-Host "Processing VM '$vmName' in Subscription '$subscriptionId'..." -ForegroundColor Yellow

    try {
        # Set the context to the specified subscription (will throw an error if subscription doesn't exist)
        Set-AzContext -SubscriptionId $subscriptionId -ErrorAction Stop | Out-Null
        Write-Host "Successfully set context to subscription '$subscriptionId'." -ForegroundColor Green
    } catch {
        Write-Warning "Subscription '$subscriptionId' does not exist or you don't have access. Skipping VM '$vmName'."
        $failureList += "$vmName (Invalid Subscription: $subscriptionId)"
        continue  # Skip to the next VM
    }

    try {
        # Get the VM by name in the specified subscription
        $vm = Get-AzVM -Name $vmName -ErrorAction SilentlyContinue

        if ($null -eq $vm) {
            Write-Warning "VM '$vmName' not found in subscription '$subscriptionId'. Skipping."
            $failureList += $vmName
            continue
        }

        Write-Host "VM '$vmName' found in subscription '$subscriptionId'." -ForegroundColor Cyan

        # Check if the tag already exists and has the desired value
        if ($vm.Tags[$category] -eq $value) {
            Write-Host "Tag '$category' already has the correct value ('$value') for VM '$vmName'. Skipping update." -ForegroundColor Cyan
            $successList += $vmName
            continue
        }

        # Prepare the new tag (add or update)
        $tag = @{ $category = $value }

        # Update the tag using Update-AzTag (Merge operation retains other tags)
        Update-AzTag -ResourceId $vm.Id -Tag $tag -Operation Merge -WhatIf
        Write-Host "Added/Updated tag '$category=$value' for VM '$vmName' in subscription '$subscriptionId'" -ForegroundColor Green
        $successList += $vmName
    } catch {
        Write-Error "Failed to update tags for VM '$vmName' in subscription '$subscriptionId': $($_.Exception.Message)"
        $failureList += $vmName
    }
}

# Summary
Write-Host "`nSummary:" -ForegroundColor Cyan
Write-Host "Successfully updated VMs:" -ForegroundColor Green
if ($successList.Count -eq 0) {
    Write-Host "None" -ForegroundColor DarkGray
} else {
    $successList | ForEach-Object { Write-Host $_ }
}

Write-Host "`nFailed to update VMs:" -ForegroundColor Red
if ($failureList.Count -eq 0) {
    Write-Host "None" -ForegroundColor DarkGray
} else {
    $failureList | ForEach-Object { Write-Warning $_ }
}

Write-Host "`nScript execution completed!" -ForegroundColor Blue
